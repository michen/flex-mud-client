<?xml version="1.0" encoding="utf-8"?>
<flexlib:MDIWindow			
	width="600" height="400"
	title="Trigger Configuration"
	showCloseButton="true"
	xmlns:flexlib="http://code.google.com/p/flexlib/"	
	xmlns:mate="http://mate.asfusion.com/"
	xmlns:mx="http://www.adobe.com/2006/mxml"
	name="triggerEditor"
	paddingLeft="5"
	paddingRight="5"
	paddingBottom="5"
	paddingTop="5" 		
	focusEnd="saveTrigger()"	
	creationComplete="init()" 	
>


  <mx:Script>
  <![CDATA[
  	import mx.collections.SortField;
  	import mx.collections.Sort;
  
  	import com.simian.profile.Trigger;
  	import mx.collections.ArrayCollection;

		[Bindable]
		public var editor_aTrigger : ArrayCollection = new ArrayCollection(); 
				
		public var editor_trigger : Trigger;
		
		public var aGroups : Array;
		
		[Bindable]
		private var acGroups : ArrayCollection = new ArrayCollection();
		
		private function init() : void {
			
			getGroups();			
			
		}
	
		// gets distinct groups
		private function getGroups() : void {
			
			trace('-- getting groups');
			
			acGroups = new ArrayCollection();			
			var oGroups : Object = new Object();			
			for each (var t : Trigger in editor_aTrigger.source) {				
				if ( !oGroups.hasOwnProperty(t.group) ) {
					acGroups.addItem(t);
					oGroups[t.group] = true;	
				}												
			}

			// sort alphabetically
			var oSort : Sort = new Sort();			
			oSort.fields = [new SortField("group",true)];			
			acGroups.sort = oSort;			
			acGroups.refresh();
			
			applyFilter();
		}
	
		private function applyFilter() : void {
			
			editor_aTrigger.filterFunction = listFilter;
			editor_aTrigger.refresh();
			
		}
	
		private function listFilter(t : Trigger) : Boolean {			
			return ( t.group == groupList.selectedItem.group );			
		}
		
		
		private function addTrigger() : void {
			
			// save anythign being edited
			if (editor_trigger) saveTrigger();
			
			var newItem : Trigger = new Trigger();
			editor_aTrigger.addItem(newItem);
			triggerList.selectedIndex = editor_aTrigger.length - 1;
			selectTrigger();			
		} 
  		
  		private function removeTrigger() : void {
  			if (triggerList.selectedIndex >= 0){
  				editor_aTrigger.removeItemAt(triggerList.selectedIndex);  				
  			} 
  		}
  		
  		public function saveTrigger() : void {  	
  			
  			if(trigger_pattern.text.length > 0) {
  			
	  			if (!editor_trigger) {
	  				editor_trigger = new Trigger();
					editor_aTrigger.addItem(editor_trigger);
					triggerList.selectedIndex = editor_aTrigger.length - 1;
	  			}  
	
	  			editor_trigger.name = trigger_name.text;
	  			editor_trigger.trigger = trigger_pattern.text;
	  			editor_trigger.group = trigger_group.text;
	  			editor_trigger.command = trigger_command.text; 
	  			editor_trigger.parse_type = int(trigger_parse_type.selectedValue);
	  			editor_trigger.bEnabled = trigger_bEnabled.selected;
	  			triggerList.invalidateList();
  			
  			}
  		  	
  		  	getGroups();  		  	
  		  	applyFilter();		
  		  	 			  			
  		}
  		
  		private function selectTrigger() : void {  			

			// save anythign being edited
			if (editor_trigger) saveTrigger();

  			if (triggerList.selectedItem) {
	  			editor_trigger = triggerList.selectedItem as Trigger;
	  			trigger_name.text = editor_trigger.name;
	  			trigger_pattern.text = editor_trigger.trigger;
	  			trigger_command.text = editor_trigger.command;  
	  			trigger_group.text = editor_trigger.group;
	  			trigger_parse_type.selectedValue = editor_trigger.parse_type;	
	  			trigger_bEnabled.selected = editor_trigger.bEnabled;	  			
	  			trigger_name.setFocus();		
  			}
  		}
  		
  		private function getLabel( trig : Trigger) : String {
  			if (trig.name.length > 0) return trig.name;
  			else return '[unnamed trigger]';
  		}

  		private function getGroup( trig : Trigger) : String {
  			if (trig.group.length > 0) return trig.group;
  			else return '[ungrouped]';
  		}	
  		
  		
  ]]>  
  </mx:Script>
  
  <mx:HBox width="95%" height="100%">
  
	<mx:VBox height="100%" width="150">		
	  	<mx:ComboBox id="groupList" dataProvider="{acGroups}" labelField="group"  width="150" change="applyFilter()" labelFunction="getGroup" />  
	    <mx:List  id="triggerList" dataProvider="{editor_aTrigger}" height="100%" width="150" change="selectTrigger()" labelFunction="getLabel"  dataChange="getGroups()" />
	</mx:VBox>
  
      
 	<mx:VBox height="100%" width="100%">
 	
 		<mx:Grid width="100%">

 			<mx:GridRow width="100%">
 				<mx:GridItem>
 					<mx:Label text="Name: "/>
 				</mx:GridItem>
 				<mx:GridItem width="100%">
 					<mx:TextInput id="trigger_name" width="100%"/>
 				</mx:GridItem> 					
 			</mx:GridRow>

 			<mx:GridRow width="100%">
 				<mx:GridItem>
 					<mx:Label text="Group: "/>
 				</mx:GridItem>
 				<mx:GridItem width="100%">
 					<mx:TextInput id="trigger_group" width="100%"/>
 				</mx:GridItem> 					
 			</mx:GridRow>
 			

 			<mx:GridRow width="100%">
 				<mx:GridItem>
 					<mx:Label text="Pattern: "/>
 				</mx:GridItem>
 				<mx:GridItem width="100%">
 					<mx:TextInput id="trigger_pattern" width="100%"/>
 				</mx:GridItem> 					
 			</mx:GridRow>

 			<mx:GridRow width="100%">
 				<mx:GridItem>
 					<mx:Label text="Parse: "/>
 				</mx:GridItem>
 				<mx:GridItem width="100%">
 					<mx:RadioButtonGroup id="trigger_parse_type"/>
 					<mx:RadioButton label="Prompt" value="0" groupName="trigger_parse_type"/>
 					<mx:RadioButton label="Line" value="1" groupName="trigger_parse_type" selected="true"/>
 					<mx:RadioButton label="Block" value="2" groupName="trigger_parse_type"/>
 				</mx:GridItem> 					
 			</mx:GridRow> 			
 			
 		</mx:Grid>
 	
 
        
      
        
        
 
        <mx:Label text="Command: "/>
        <mx:TextArea id="trigger_command" width="100%" height="100%"/>
 		
 		<mx:CheckBox id="trigger_bEnabled" label="Enabled" selected="true" />
 		
 		<mx:Spacer width="100%" height="20"/>
 		
 		
		<mx:HBox width="100%">
			<mx:Button  label="New" click="addTrigger()"/>
			<mx:Button  label="Save" click="saveTrigger()"/>
			<mx:Spacer width="100%" />

			<mx:Button  label="Delete" click="removeTrigger()" />
		</mx:HBox>
 		
 	</mx:VBox>
 
  </mx:HBox>

	

				
</flexlib:MDIWindow>
